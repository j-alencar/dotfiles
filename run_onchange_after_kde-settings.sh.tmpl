#!/bin/bash
# hash: {{ include "dot_config/kwinrc" | sha256sum }}
# hash: {{ include "dot_config/kdeglobals" | sha256sum }}
# hash: {{ include "dot_config/kglobalshortcutsrc" | sha256sum }}
# hash: {{ include "dot_config/plasmarc" | sha256sum }}


{{ if ne .chezmoi.os "linux" }}
exit 0
{{ end }}

set -euo pipefail

IS_WSL=false
[[ -f /proc/version ]] && grep -qi microsoft /proc/version && IS_WSL=true

if [[ "$IS_WSL" == "true" ]]; then
    exit 0
fi

{{ if eq .chezmoi.osRelease.id "arch" }}
if command -v plasma-apply-lookandfeel &>/dev/null; then
    plasma-apply-lookandfeel com.github.vinceliuice.Graphite-dark 2>/dev/null || true
fi

if command -v plasma-apply-colorscheme &>/dev/null; then
    plasma-apply-colorscheme Gruvbox 2>/dev/null || true
fi

if command -v plasma-apply-desktoptheme &>/dev/null; then
    plasma-apply-desktoptheme gruvbox 2>/dev/null || true
fi

if command -v plasma-apply-cursortheme &>/dev/null; then
    plasma-apply-cursortheme Graphite-dark 2>/dev/null || true
fi
{{ end }}

if command -v kwriteconfig6 &>/dev/null; then
    while IFS= read -r line; do
        [[ "$line" =~ ^\[(.+)\]$ ]] && group="${BASH_REMATCH[1]}" && continue
        [[ -z "$line" || "$line" =~ ^# ]] && continue
        key="${line%%=*}"
        value="${line#*=}"
        kwriteconfig6 --file kglobalshortcutsrc --group "$group" --key "$key" "$value"
    done < "${HOME}/.config/kglobalshortcutsrc"
fi

if command -v qdbus &>/dev/null && qdbus org.kde.KWin /KWin 2>/dev/null; then
    qdbus org.kde.KWin /KWin reconfigure 2>/dev/null || true
fi

if command -v qdbus &>/dev/null; then
    qdbus org.kde.keyboard /modules/keys org.kde.kglobalaccel.reloadConfig 2>/dev/null || true
fi

if command -v plasmashell &>/dev/null; then
    plasmashell --replace &>/dev/null &
    disown
fi
